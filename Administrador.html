<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Administrador ILUO - Isovolta</title>
  <link rel="icon" type="image/png" href="Isovolta.ico">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #eef1f7;
      margin: 0;
      padding: 20px;
      padding-bottom: 48px;
    }
    .logo {display: block; margin: 0 auto; max-height: 70px;}
    h1 {text-align: center; color: #00205B; margin-bottom: 18px; letter-spacing: 1px;}
    .filter-container {
      display: flex; gap: 10px; flex-wrap: wrap; margin: 16px 0 10px 0; justify-content: flex-start;
    }
    .filter-container input, .filter-container select {
      padding: 7px; border-radius: 7px; border: 1px solid #cfd8dc;
      font-size: 1em; outline: none; background: #f5f8fa; margin-bottom: 5px;
    }
    .filter-container input:focus, .filter-container select:focus {border-color: #0077be; background: #e2eaf7;}
    .btn, .table-btn {
      display: inline-flex; align-items: center; gap: 7px;
      background: #00529b; border: none; color: #fff; font-weight: 600;
      border-radius: 8px; font-size: 1em; padding: 8px 20px;
      box-shadow: 0 2px 9px rgba(0,32,91,0.11); cursor: pointer;
      transition: background 0.22s, transform 0.13s, box-shadow 0.18s;
      margin: 2px 6px 10px 0;
    }
    .btn:hover, .table-btn:hover {
      background: linear-gradient(90deg, #003866 40%, #0077be 100%);
      transform: translateY(-2px) scale(1.035);
      box-shadow: 0 6px 22px rgba(0,32,91,0.18);
    }
    .table-btn {
      background: linear-gradient(90deg, #ef4444 65%, #be1818 100%);
      padding: 6px 16px; font-size: 1em; gap: 5px;
    }
    .table-btn:hover {
      background: linear-gradient(90deg, #be1818 65%, #ef4444 100%);
    }
    table {
      width: 100%; max-width: 100%; border-collapse: collapse;
      font-size: 13px; margin-top: 10px; background: #fff;
      border-radius: 10px; box-shadow: 0 0 14px rgba(0,0,0,0.04);
      overflow: hidden;
    }
    th, td {
      border: 1px solid #d5d7de; padding: 7px 12px; white-space: nowrap; text-align: left;
    }
    th {
      background-color: #00205B; color: white; font-weight: 600; letter-spacing: .2px;
    }
    td[contenteditable="true"] {background-color: #f8fcfd; transition: background 0.2s;}
    td[contenteditable="true"]:focus {background: #e2eaf7;}
    @media (max-width: 900px) {
      .filter-container {flex-direction: column; align-items: stretch;}
      table { font-size: 12px; }
      .btn, .table-btn { font-size: 0.93em; padding: 7px 11px;}
    }
    @media (max-width: 650px) {
      table { font-size: 11px; }
      th, td { padding: 5px 4px; }
      .btn { font-size: 0.90em; padding: 7px 8px;}
    }
    footer {
      width: 100vw; background: #00529b; color: #fff; text-align: center;
      padding: 14px 0 12px 0; position: fixed; left: 0; bottom: 0;
      font-size: 1.08em; letter-spacing: 0.8px; z-index: 50;
      border-bottom-left-radius: 12px; border-bottom-right-radius: 12px;
    }
  </style>
</head>
<body>
<img src="https://www.isovolta.com/logo_isovolta.png" alt="Logo Isovolta" class="logo">
<h1>Administrador ILUO</h1>

<div class="filter-container" id="filtrosArriba">
  <select id="filtroArea" style="min-width:170px;margin-right:7px;" onchange="onAreaChange()"></select>
  <select id="filtroPuesto" style="min-width:200px;margin-right:20px;" onchange="onPuestoChange()"></select>
  <input type="text" id="filtroCodigo" placeholder="Filtrar por Código" oninput="filtrarTabla()">
  <input type="text" id="filtroDocumento" placeholder="Filtrar por Documento" oninput="filtrarTabla()">
  <input type="text" id="filtroCapacitador" placeholder="Filtrar por Capacitador" oninput="filtrarTabla()">
</div>
<div style="margin-bottom:12px;">
  <button class="btn" onclick="agregarDocumento()">
    <svg height="18" width="18" viewBox="0 0 20 20" fill="none"><path d="M10 4v12m6-6H4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
    Agregar Documento
  </button>
  
  <button class="btn" onclick="guardarCambios()">
    <svg height="18" width="18" viewBox="0 0 20 20" fill="none"><path d="M4 4v12h12V4H4zm2 2h8v2H6V6zm0 4h8v2H6v-2zm0 4h8v2H6v-2z" fill="currentColor"/></svg>
    Guardar Cambios
  </button>
</div>
<div id="contenedorTabla"></div>
<footer>
    Herramienta diseñada por el departamento de Producción & Mejora Continua
</footer>

<script>
// ========== IndexedDB Setup ==========
const DB_NAME = 'ILUO_DB';
const DB_VERSION = 1;
const STORE_NAME = 'respaldo';

function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: 'clave' });
      }
    };
    request.onsuccess = () => resolve(request.result);
    request.onerror = (event) => reject(event.target.error);
  });
}
async function guardarEnIndexedDB(clave, valor) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    store.put({ clave, valor });
    tx.oncomplete = () => resolve();
    tx.onerror = (e) => reject(e.target.error);
  });
}
async function leerDeIndexedDB(clave) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const req = store.get(clave);
    req.onsuccess = () => resolve(req.result ? req.result.valor : null);
    req.onerror = (e) => reject(e.target.error);
  });
}
async function migrarLocalStorageAIndexedDB() {
  const claves = ["documentosILUO", "matrizILUO"];
  for (const clave of claves) {
    const val = localStorage.getItem(clave);
    if (val && !(await leerDeIndexedDB(clave))) {
      await guardarEnIndexedDB(clave, JSON.parse(val));
    }
  }
}

// ========== Variables ==========
let personasILUO = [];
let documentosILUO = [];
let areas = [];
let puestosPorArea = {};
let areaActiva = "";
let puestoActivo = "";

// ========== Inicialización ==========
window.onload = async function() {
  await migrarLocalStorageAIndexedDB();
  personasILUO = await leerDeIndexedDB("matrizILUO") || [];
  documentosILUO = await leerDeIndexedDB("documentosILUO") || [];

  // Construir lista de áreas y puestos
  areas = [...new Set(personasILUO.map(p => (p.area||"").trim()).filter(Boolean))].sort();
  puestosPorArea = {};
  personasILUO.forEach(p => {
    const area = (p.area || "").trim();
    const puesto = (p.puesto || "").trim();
    if (!area || !puesto) return;
    if (!puestosPorArea[area]) puestosPorArea[area] = [];
    if (!puestosPorArea[area].includes(puesto)) puestosPorArea[area].push(puesto);
  });

  // Set defaults
  areaActiva = areas[0] || "";
  puestoActivo = puestosPorArea[areaActiva]?.[0] || "";

  cargarDropdowns();
  renderTabla();
};

function cargarDropdowns() {
  // Área
  const areaSel = document.getElementById("filtroArea");
  areaSel.innerHTML = areas.map(area =>
    `<option value="${area}" ${area === areaActiva ? "selected" : ""}>${area}</option>`
  ).join("");
  // Puestos solo de esa área
  cargarDropdownPuestos();
}

function cargarDropdownPuestos() {
  const puestoSel = document.getElementById("filtroPuesto");
  const puestos = puestosPorArea[areaActiva] || [];
  puestoSel.innerHTML = puestos.map(puesto =>
    `<option value="${puesto}" ${puesto === puestoActivo ? "selected" : ""}>${puesto}</option>`
  ).join("");
  if (!puestos.includes(puestoActivo)) {
    puestoActivo = puestos[0] || "";
  }
}

// ========== Event Handlers ==========
function onAreaChange() {
  areaActiva = document.getElementById("filtroArea").value;
  const puestos = puestosPorArea[areaActiva] || [];
  puestoActivo = puestos[0] || "";
  cargarDropdownPuestos();
  renderTabla();
}

function onPuestoChange() {
  puestoActivo = document.getElementById("filtroPuesto").value;
  renderTabla();
}

function filtrarTabla() {
  renderTabla();
}

// ========== Render Tabla ==========
function renderTabla() {
  const filtroCodigo = (document.getElementById("filtroCodigo")?.value || "").toLowerCase();
  const filtroDoc = (document.getElementById("filtroDocumento")?.value || "").toLowerCase();
  const filtroCap = (document.getElementById("filtroCapacitador")?.value || "").toLowerCase();

  let docs = documentosILUO.filter(doc =>
    doc.area === areaActiva &&
    doc.puesto === puestoActivo &&
    (!filtroCodigo || (doc.codigo||"").toLowerCase().includes(filtroCodigo)) &&
    (!filtroDoc || (doc.documento||"").toLowerCase().includes(filtroDoc)) &&
    (!filtroCap || (doc.capacitador||"").toLowerCase().includes(filtroCap))
  );

  let html = `<table>
    <thead>
      <tr>
        <th>Código</th><th>Revisión</th><th>Documento</th><th>Capacitador</th><th>Tipo de Categoría</th><th>Puesto</th><th>Área</th><th>Eliminar</th>



      </tr>
    </thead>
    <tbody>
      ${docs.map(doc => `
        <tr>
          <td contenteditable="true">${doc.codigo || ""}</td>
          <td contenteditable="true">${doc.revision || ""}</td>
          <td contenteditable="true">${doc.documento || ""}</td>
          <td contenteditable="true">${doc.capacitador || ""}</td>
          <td contenteditable="true">${doc.tipoCategoria || ""}</td>
          <td>${doc.puesto}</td>
          <td>${doc.area}</td>
          <td><button class="table-btn" onclick="eliminarDocumentoPorCodigo('${doc.codigo}')">Eliminar</button></td>
        </tr>
      `).join("")}
    </tbody>
  </table>`;
  document.getElementById("contenedorTabla").innerHTML = html;
}

// ========== CRUD ==========
async function agregarDocumento() {
  if (!areaActiva || !puestoActivo) {
    alert("Primero selecciona área y puesto");
    return;
  }
  documentosILUO.push({
    codigo: "", documento: "", capacitador: "", revision: "",
    tipoCategoria: "", puesto: puestoActivo, area: areaActiva
  });
  await guardarEnIndexedDB("documentosILUO", documentosILUO);
  renderTabla();
}

async function guardarCambios() {
  // Solo guarda los documentos del área+puesto actual que se ven en pantalla
  let nuevos = [];
  document.querySelectorAll("#contenedorTabla tbody tr").forEach(fila => {
    const celdas = fila.querySelectorAll("td");
    nuevos.push({
      codigo: celdas[0].innerText.trim(),
      documento: celdas[1].innerText.trim(),
      capacitador: celdas[2].innerText.trim(),
      revision: celdas[3].innerText.trim(),
      tipoCategoria: celdas[4].innerText.trim(),
      puesto: puestoActivo,
      area: areaActiva
    });
  });
  // El resto no se toca
  documentosILUO = documentosILUO.filter(doc => !(doc.area === areaActiva && doc.puesto === puestoActivo)).concat(nuevos);
  await guardarEnIndexedDB("documentosILUO", documentosILUO);
  alert("Cambios guardados correctamente");
  renderTabla();
}

async function eliminarDocumentoPorCodigo(codigo) {
  const pass = prompt("Ingrese contraseña para eliminar:");
  if (pass !== "Isovolta2025") {
    alert("Contraseña incorrecta");
    return;
  }
  documentosILUO = documentosILUO.filter(doc => !(doc.codigo === codigo && doc.area === areaActiva && doc.puesto === puestoActivo));
  await guardarEnIndexedDB("documentosILUO", documentosILUO);
  renderTabla();
}
// === Permitir pegar tipo Excel en la tabla ===
document.addEventListener("DOMContentLoaded", () => {
  document.addEventListener("paste", function(event) {
    // Solo si la tabla está visible y hay una celda editable activa
    const active = document.activeElement;
    if (!active || active.tagName !== "TD" || !active.isContentEditable) return;
    const tabla = active.closest("table");
    if (!tabla) return;

    event.preventDefault();
    let data = (event.clipboardData || window.clipboardData).getData('text');
    let rows = data.split('\n').map(r => r.replace(/\r/g, '').split('\t'));

    // Encuentra celda, fila y columna inicial
    let cell = active;
    let tr = cell.parentElement;
    let tdIndex = Array.from(tr.children).indexOf(cell); // celda inicial
    let trIndex = Array.from(tabla.tBodies[0].rows).indexOf(tr); // fila inicial

    // Solo pega sobre columnas editables (0 a 4)
    for (let i = 0; i < rows.length; i++) {
      let row = rows[i];
      let currentTr = tabla.tBodies[0].rows[trIndex + i];
      if (!currentTr) break;
      for (let j = 0; j < row.length; j++) {
        if (tdIndex + j > 4) break; // solo hasta la 5ta columna editable
        let currentTd = currentTr.cells[tdIndex + j];
        if (currentTd && currentTd.isContentEditable) {
          currentTd.innerText = row[j];
        }
      }
    }
  });
});


</script>
</body>
</html>
