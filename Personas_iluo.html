<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Personas ILUO - Isovolta</title>
  <link rel="icon" type="image/png" href="Isovolta.ico">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f7fb;
      margin: 0;
      padding: 0 0 65px 0;
    }
    .logo {
      display: block;
      margin: 35px auto 10px auto;
      max-height: 68px;
    }
    h1 {
      text-align: center;
      color: #00205B;
      font-size: 2.1em;
      margin: 6px 0 16px 0;
      letter-spacing: 1px;
    }
    .back-btn {
      display: flex;
      margin-bottom: 8px;
      margin-top: -18px;
    }
    .container {
      max-width: 1020px;
      margin: 0 auto 32px auto;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,32,91,0.07);
      padding: 28px 28px 18px 28px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 15px;
      margin: 0 auto 20px auto;
      background: #fafdff;
      border-radius: 8px;
      box-shadow: 0 1px 9px rgba(0,32,91,0.03);
      overflow: hidden;
    }
    th, td {
      padding: 10px 10px;
      border: 1px solid #d2d7e6;
      text-align: left;
      vertical-align: middle;
      font-size: 15px;
    }
    th {
      background: #015197;
      color: #fff;
      font-weight: 600;
      letter-spacing: .5px;
    }
    td[contenteditable="true"] {
      background-color: #fffbe6;
      transition: background 0.2s;
    }
    td[contenteditable="true"]:focus {
      background: #eaf6ff;
      outline: 2px solid #b7e0fd;
    }
    input[type="date"] {
      padding: 5px 8px;
      border: 1px solid #ccd6df;
      border-radius: 5px;
      width: 100%;
      font-size: 15px;
      background: #f8fcfd;
      box-sizing: border-box;
    }
    .actions {
      text-align: center;
      margin-top: 26px;
    }
    .btn {
      background: #015197;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1.07em;
      font-weight: bold;
      padding: 9px 22px;
      cursor: pointer;
      margin: 0 10px 5px 0;
      letter-spacing: .3px;
      box-shadow: 0 2px 8px rgba(0,32,91,0.09);
      transition: background 0.18s, transform 0.15s, box-shadow 0.16s;
      outline: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn:hover {
      background: #003366;
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 5px 14px rgba(0,32,91,0.14);
    }
    button.delete-btn {
      background-color: #c62828;
      color: white;
      border: none;
      padding: 6px 13px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1em;
      box-shadow: 0 1px 5px rgba(198,40,40,0.07);
      transition: background 0.2s;
    }
    button.delete-btn:hover {
      background-color: #b71c1c;
    }
    footer {
      width: 100vw;
      background: #00529b;
      color: #fff;
      text-align: center;
      padding: 14px 0 12px 0;
      position: fixed;
      left: 0;
      bottom: 0;
      font-size: 1.08em;
      letter-spacing: 0.8px;
      z-index: 50;
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
    }
    @media (max-width: 900px) {
      .container { padding: 6px 2vw 18px 2vw; }
      th, td { font-size: 13px; padding: 8px 5px; }
      h1 { font-size: 1.35em; }
      .logo { max-height: 40px; }
    }
    @media (max-width: 650px) {
      .container { padding: 0; box-shadow: none;}
      table { font-size: 12px; }
      .btn { font-size: 0.93em; padding: 8px 8px; }
      th, td { padding: 6px 3px; }
    }
  </style>
</head>
<body>

<img src="https://www.isovolta.com/logo_isovolta.png" alt="Logo Isovolta" class="logo">
<h1>Gesti√≥n de Personas ILUO</h1>
<div class="back-btn"></div>
<div class="container">
  <!-- NUEVOS FILTROS -->
  <div style="margin-bottom: 18px; display: flex; gap: 15px; flex-wrap: wrap;">
    <select id="filtroArea" onchange="onAreaFilter()" style="padding:6px; min-width:170px;"></select>
    <select id="filtroPuesto" onchange="filtrarPersonas()" style="padding:6px; min-width:200px;"></select>
    <input type="text" id="filtroNombre" placeholder="Buscar por nombre..." style="padding:6px; min-width:220px;" oninput="filtrarPersonas()">
    <input type="text" id="filtroNumero" placeholder="Buscar por n√∫mero..." style="padding:6px; min-width:110px;" oninput="filtrarPersonas()">
  </div>
  <table>
    <thead>
      <tr>
        <th>N√∫mero</th><th>Nombre</th><th>Puesto</th><th>√Årea</th><th>Fecha Ingreso</th><th>Eliminar</th>
      </tr>
    </thead>
    <tbody id="tablaPersonas"></tbody>
  </table>
  <div class="actions">
    <button class="btn" onclick="agregarPersona()">‚ûï Agregar Persona</button>
    <button class="btn" onclick="guardarPersonas()">üíæ Guardar Cambios</button>
  </div>
</div>

<script>
// ========== IndexedDB Helper ==========
const DB_NAME = 'ILUO_DB';
const DB_VERSION = 1;
const STORE_NAME = 'respaldo';

function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: 'clave' });
      }
    };
    request.onsuccess = () => resolve(request.result);
    request.onerror = (event) => reject(event.target.error);
  });
}

async function guardarEnIndexedDB(clave, valor) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    store.put({ clave, valor });
    tx.oncomplete = () => resolve();
    tx.onerror = (e) => reject(e.target.error);
  });
}

async function leerDeIndexedDB(clave) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const req = store.get(clave);
    req.onsuccess = () => resolve(req.result ? req.result.valor : null);
    req.onerror = (e) => reject(e.target.error);
  });
}

// ========== Migrar de localStorage si hace falta ==========
async function migrarLocalStorageAIndexedDB() {
  const clave = "matrizILUO";
  const val = localStorage.getItem(clave);
  if (val && !(await leerDeIndexedDB(clave))) {
    await guardarEnIndexedDB(clave, JSON.parse(val));
    // localStorage.removeItem(clave); // Opcional: borra si ya migraste.
  }
}

let personasFull = [];
let areasUnicas = [];
let puestosPorArea = {};
let areaActiva = "";
let puestoActivo = "";

async function cargarPersonas() {
  await migrarLocalStorageAIndexedDB();
  personasFull = await leerDeIndexedDB("matrizILUO") || [];
  // Obtener √°reas √∫nicas
  areasUnicas = [...new Set(personasFull.map(p => (p.area||"").trim()).filter(Boolean))].sort();
  // Mapear puestos por √°rea
  puestosPorArea = {};
  personasFull.forEach(p => {
    const area = (p.area||"").trim();
    const puesto = (p.puesto||"").trim();
    if (!area || !puesto) return;
    if (!puestosPorArea[area]) puestosPorArea[area] = [];
    if (!puestosPorArea[area].includes(puesto)) puestosPorArea[area].push(puesto);
  });

  // MANTENER FILTROS
  // Lee cu√°l es el √°rea y puesto activos seleccionados actualmente en los filtros
  const selArea = document.getElementById("filtroArea")?.value;
  const selPuesto = document.getElementById("filtroPuesto")?.value;
  areaActiva = selArea !== undefined && selArea !== null ? selArea : (areasUnicas[0] || "");
  puestoActivo = selPuesto !== undefined && selPuesto !== null ? selPuesto : "";

  cargarDropdowns();
  filtrarPersonas();
}


function cargarDropdowns() {
  // √Åreas con opci√≥n 'Todos'
  const areaSel = document.getElementById("filtroArea");
  areaSel.innerHTML = ['<option value="">Todos</option>'].concat(
    areasUnicas.map(area =>
      `<option value="${area}" ${area === areaActiva ? "selected" : ""}>${area}</option>`
    )
  ).join("");
  // Puestos para √°rea activa o todos los puestos si √°rea vac√≠a
  cargarDropdownPuestos();
}

function cargarDropdownPuestos() {
  const puestoSel = document.getElementById("filtroPuesto");
  let puestos = [];
  if (!areaActiva) {
    // Si est√° en 'Todos', mostrar todos los puestos √∫nicos de todas las √°reas
    puestos = [...new Set(personasFull.map(p => (p.puesto||"").trim()).filter(Boolean))].sort();
  } else {
    puestos = puestosPorArea[areaActiva] || [];
  }
  puestoSel.innerHTML = ['<option value="">Todos los puestos</option>'].concat(
    puestos.map(puesto =>
      `<option value="${puesto}" ${puesto === puestoActivo ? "selected" : ""}>${puesto}</option>`
    )
  ).join("");
  if (!puestos.includes(puestoActivo)) puestoActivo = "";
}

function onAreaFilter() {
  areaActiva = document.getElementById("filtroArea").value;
  puestoActivo = ""; // reset puesto
  cargarDropdownPuestos();
  filtrarPersonas();
}

function filtrarPersonas() {
  let nombreFiltro = (document.getElementById("filtroNombre")?.value || "").toLowerCase();
  let numeroFiltro = (document.getElementById("filtroNumero")?.value || "").toLowerCase();
  areaActiva = document.getElementById("filtroArea").value;
  puestoActivo = document.getElementById("filtroPuesto").value;

  const tbody = document.getElementById("tablaPersonas");
  tbody.innerHTML = "";
  let filtrados = personasFull.filter(p =>
    (!areaActiva || (p.area||"") === areaActiva) &&
    (!puestoActivo || (p.puesto||"") === puestoActivo) &&
    (!nombreFiltro || (p.nombre||"").toLowerCase().includes(nombreFiltro)) &&
    (!numeroFiltro || (p.numero||"").toLowerCase().includes(numeroFiltro))
  );
  filtrados.forEach((p) => {
    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td contenteditable="true">${p.numero}</td>
      <td contenteditable="true">${p.nombre}</td>
      <td contenteditable="true">${p.puesto}</td>
      <td contenteditable="true">${p.area}</td>
      <td><input type="date" value="${p.fechaIngreso || ''}"></td>
      <td><button class="delete-btn" onclick="eliminarPersonaPorNumero('${p.numero}')">Eliminar</button></td>
    `;
    tbody.appendChild(fila);
  });
}

async function agregarPersona() {
  const personas = await leerDeIndexedDB("matrizILUO") || [];
  personas.push({ numero: "", nombre: "", puesto: "", area: "", fechaIngreso: "", foto: "", documentacion: [] });
  await guardarEnIndexedDB("matrizILUO", personas);
  cargarPersonas();
}

// *** FUNCI√ìN CORREGIDA ***
async function guardarPersonas() {
  // Lee toda la base de personas
  let personasGuardadas = await leerDeIndexedDB("matrizILUO") || [];
  let nuevas = [];
  // Obt√©n los n√∫meros de las personas editadas en pantalla
  let editados = [];
  document.querySelectorAll("#tablaPersonas tr").forEach((fila) => {
    const celdas = fila.querySelectorAll("td");
    const fechaInput = celdas[4].querySelector("input[type='date']");
    const numero = celdas[0].innerText.trim();
    editados.push(numero);
    // Busca si existe en la base
    const existente = personasGuardadas.find(p => p.numero === numero);
    nuevas.push({
      numero: numero,
      nombre: celdas[1].innerText.trim(),
      puesto: celdas[2].innerText.trim(),
      area: celdas[3].innerText.trim(),
      fechaIngreso: fechaInput ? fechaInput.value : "",
      foto: existente?.foto || "",
      documentacion: existente?.documentacion || []
    });
  });
  // Agrega los NO VISIBLES (no editados) a la lista final
  personasGuardadas.forEach(p => {
    if (!editados.includes(p.numero)) {
      nuevas.push(p);
    }
  });
  await guardarEnIndexedDB("matrizILUO", nuevas);
  alert("Personas actualizadas correctamente");
  cargarPersonas();
}

async function eliminarPersonaPorNumero(numero) {
  const pass = prompt("Ingrese contrase√±a para eliminar:");
  if (pass !== "Isovolta2025") {
    alert("Contrase√±a incorrecta");
    return;
  }
  let personas = await leerDeIndexedDB("matrizILUO") || [];
  const index = personas.findIndex(p => p.numero === numero);
  if (index >= 0) {
    personas.splice(index, 1);
    await guardarEnIndexedDB("matrizILUO", personas);
    cargarPersonas();
  } else {
    alert("No se encontr√≥ a la persona con n√∫mero " + numero);
  }
}

// Al cargar la p√°gina
cargarPersonas();
</script>
<footer>
    Herramienta dise√±ada por el departamento de Producci√≥n & Mejora Continua
</footer>
</body>
</html>

